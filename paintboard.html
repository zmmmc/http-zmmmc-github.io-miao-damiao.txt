<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<style>
  div {
    width: 100%;
    height: 800px;
    border: 1px solid black;
    position: relative;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 55px;
    position: absolute;
  }

  svg {
    width: 1760px;
    height: 800px;
    position: absolute;
  }

  input {
    margin-left: 10px;
    vertical-align: bottom;
  }
</style>

<body>
  <div>
    <!--version="1.0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 0 800 800" svgä¿å­˜éœ€è¦æ·»åŠ çš„å†…å®¹  -->
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 0 1760 800"></svg>
  </div><br>
  å·¥å…· <button onclick=" tool = 'line' ">ğŸ“‰</button>
  <button onclick=" tool = 'circle' ">âšª</button>
  <button onclick=" tool = 'rect' ">â¬œ</button>
  é¢œè‰² <input type="color" id="colorInput">
  çº¿æ¡ç²—ç»† <input type="range" id="lineWidth" min="1" max="18" value="2">
  <span>2</span>
  <button onclick=" save() ">ä¿å­˜</button><br>
  çŸ©å½¢æ°´å¹³æ–¹å‘åœ†è§’<input type="range" id="horRadius" min="1" max="99"><span></span><br>
  çŸ©å½¢å‚ç›´æ–¹å‘åœ†è§’<input type="range" id="verRadius" min="0" max="99"><span></span>
  <script>

    let div = document.querySelector("div")

    let svg = document.querySelector("svg")

    let tool = "line"


    svg.addEventListener("mousedown", function (e) {
      drawNotSave = true
      if (tool == "line") {

        let pos = mousePos(svg)
        //åˆ›å»ºæŠ˜çº¿å…ƒç´  polylineå…ƒç´ æ˜¯SVGçš„ä¸€ä¸ªåŸºæœ¬å½¢çŠ¶ï¼Œç”¨æ¥åˆ›å»ºä¸€ç³»åˆ—ç›´çº¿è¿æ¥å¤šä¸ªç‚¹ã€‚
        //å…¸å‹çš„ä¸€ä¸ªpolylineæ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªå¼€æ”¾çš„å½¢çŠ¶ï¼Œæœ€åä¸€ç‚¹ä¸ä¸ç¬¬ä¸€ç‚¹ç›¸è¿ã€‚æ¬²äº†è§£é—­åˆå½¢çŠ¶
        let polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline")

        //è®¾ç½®çº¿æ¡é¢œè‰²
        polyline.setAttribute("stroke", colorInput.value)
        //è®¾ç½®çº¿æ¡çš„å®½åº¦
        polyline.setAttribute("stroke-width", lineWidth.value)
        //è®¾ç½®çº¿æ¡çš„è¾¹ç¼˜æ€§è´¨ï¼Œé»˜è®¤ä¸º"butt"ï¼Œæ— å¤–åŒ…é•¿æ–¹å½¢çš„è¾¹è§’ï¼Œ"round"ï¼Œåœ†å½¢è¾¹è§’ï¼Œ"square"å¤–åŒ…é•¿æ–¹å½¢è¾¹è§’
        polyline.setAttribute("stroke-linecap", "round")
        //è®¾ç½®æŠ˜çº¿æŠ˜è½¬æ—¶çš„å½¢çŠ¶
        polyline.setAttribute("stroke-linejoin", "round")
        //æŠ˜çº¿ä¼šè‡ªåŠ¨å¡«å……ï¼Œéœ€è¦å°†å¡«å……å»æ‰
        polyline.setAttribute("fill", "none")

        svg.append(polyline)
        //è®¾ç½®ç‚¹çš„åæ ‡
        let points = `${pos.x} ${pos.y} `
        //å°†åæ ‡ç‚¹è®¾ç½®åœ¨polylineä¸Š
        polyline.setAttribute("points", points)
        function move(e) {

          let pos = mousePos(svg)
          //é¼ æ ‡ç§»åŠ¨åˆ›å»ºæ–°çš„åæ ‡æ‹¼æ¥åœ¨å‰é¢çš„åæ ‡ä¹‹å‰
          points += `${pos.x} ${pos.y} `
          //å°†åé¢æ‹¼æ¥çš„åæ ‡è®¾ç½®åˆ°polylineä¸Š
          polyline.setAttribute("points", points)

        }
        document.addEventListener("mousemove", move)
        document.addEventListener("mouseup", function () {
          lastPos = null
          document.removeEventListener("mousemove", move)
        })
      }

      if (tool == "circle") {
        let ellipse = document.createElementNS("http://www.w3.org/2000/svg", "ellipse")
        svg.append(ellipse)
        ellipse.setAttribute("stroke", colorInput.value)
        ellipse.setAttribute("stroke-width", lineWidth.value)
        ellipse.setAttribute("fill", "none")
        //èµ·ç‚¹
        let startPos = mousePos(svg)
        function drawElipse() {
          //ç»ˆç‚¹
          let currPos = mousePos(svg)
          //è®¾ç½®åœ†å¿ƒ
          let cx = (startPos.x + currPos.x) / 2
          let cy = (startPos.y + currPos.y) / 2
          //å°†åœ†å¿ƒè®¾ç½®åˆ°åœ†ä¸Š
          ellipse.setAttribute("cx", cx)
          ellipse.setAttribute("cy", cy)
          //è®¾ç½®é•¿çŸ­è½´
          let rx = Math.abs(startPos.x - currPos.x) / 2
          let ry = Math.abs(startPos.y - currPos.y) / 2
          ellipse.setAttribute("rx", rx)
          ellipse.setAttribute("ry", ry)
        }
        document.addEventListener("mousemove", drawElipse)
        document.addEventListener("mouseup", function () {
          document.removeEventListener("mousemove", drawElipse)
        })
      }

      if (tool == "rect") {
        let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect")
        svg.append(rect)
        rect.setAttribute("stroke", colorInput.value)
        rect.setAttribute("stroke-width", lineWidth.value)
        rect.setAttribute("fill", "none")
        let startCoord = mousePos(svg)
        function drawRect(e) {
          let endCoord = mousePos(svg)
          let width = endCoord.x - startCoord.x
          let height = endCoord.y - startCoord.y
          let x = e.pageX - width
          let y = e.pageY - height
          rect.setAttribute("width", width)
          rect.setAttribute("height", height)
          rect.setAttribute("x", x)
          rect.setAttribute("y", y)
          //è®¾ç½®æ°´å¹³ä¸å‚ç›´æ–¹å‘çš„åœ†è§’
          rect.setAttribute("rx", horRadius.value)
          rect.setAttribute("ry", verRadius.value)
        }
        document.addEventListener("mousemove", drawRect)
        document.addEventListener("mouseup", function () {
          document.removeEventListener("mousemove", drawRect)
        })
      }


    })

    //å½“svgå­˜åœ¨æ—¶ï¼ŒæŒ‰ä½ctrl+zé”®æ’¤é”€svgåˆ›å»ºçš„æœ€åä¸€ä¸ªå…ƒç´ 
    document.addEventListener("keydown", e => {
      if (e.key == "z" && e.ctrlKey) {
        svg.lastElementChild && svg.removeChild(svg.lastElementChild)
      }
    })


    let lineWidth = document.querySelector("#lineWidth")
    let span = document.querySelector("span")
    lineWidth.addEventListener("input", e => {
      span.textContent = lineWidth.value
    })

    function mousePos(node) {
      //getBoundingClientRect()è¿”å›ä¸€ä¸ªå…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚
      let box = node.getBoundingClientRect()
      return {
        x: window.event.clientX - box.x,
        y: window.event.clientY - box.y,
      }
    }

    let drawNotSave = false
    //å½“é¼ æ ‡åœ¨ç”»æ¿æŒ‰ä¸‹æ—¶ä¾¿è¿›å…¥åˆ¤æ–­éœ€è¦ä¿å­˜ï¼Œç›´æ¥é€€å‡ºä¼šå¼¹å‡ºæ˜¯å¦ä¿å­˜æç¤º
    window.addEventListener("beforeunload", e => {
      if (drawNotSave) {
        return e.returnValue = "è¿˜æœªä¿å­˜" || e.preventDefault()
      }
    })
    function save() {
      //å½“ç”»æ¿å†…å®¹ä¿å­˜ååˆ™ä¸è¿›å…¥ä¹‹å‰ä¿å­˜æç¤º
      drawNotSave = false
      //æ‹¿åˆ°svgçš„æºä»£ç 
      let svgSource = svg.outerHTML
      //åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜æ–‡ä»¶çš„å†…å®¹ä»¥åŠæ–‡ä»¶çš„ç±»å‹
      let blob = new Blob([svgSource], { type: "image/xml+svg" })
      //åˆ›å»ºä¸€ä¸ªé“¾æ¥ï¼Œé“¾æ¥åˆ°ä¿å­˜çš„æ–‡ä»¶
      let url = URL.createObjectURL(blob)
      //åˆ›å»ºä¸€ä¸ªaæ ‡ç­¾ï¼Œä¿å­˜ä¸Šé¢åˆ›å»ºçš„é“¾æ¥
      let anchor = document.createElement("a")
      anchor.href = url
      //ä¸‹è½½é“¾æ¥å†…å®¹ï¼Œä»¥xxx.svgå‘½å
      anchor.download = "xxaa.svg"
      anchor.click()
    }
  </script>
</body>

</html>
